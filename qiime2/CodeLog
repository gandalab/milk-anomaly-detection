# Running Differential Abundance in Milk Anomaly Detection Samples
# By Erika ErikaGanda

#Starting files:
#Raw read counts with contaminants removed: read_counts_decontaminated.txt

#Golden file:
#RPM with contaminants removed, supported only (RPM > 0.1)
#milk-real-samples-decontam-RPM-supported-microbes-only_from_DS10828562.txt

#///////////////////////////////////////////////////////////////////////////////

# go to right directory

cd /Users/evk5387/OneDrive\ -\ The\ Pennsylvania\ State\ University/Git-ErikaGanda-Code/milk-anomaly-detection

# make sure things are being tracked on git

git pull
git status

#go to analysis folder
cd qiime2

# transform kraken table into biom table
# this would work if we had the kraken output, however we have a processed text file, so the code below throws an error.
#pip install kraken-biom
#kraken-biom qiime2/read_counts_decontaminated.txt -o qiime2/read_counts_decontaminated.biom


# as a workaround, I saved read_counts_decontaminated.txt as read_counts_decontaminated.csv, opened it on excel and copied the values and pasted into a file that had the necessary first row # Constructed from biom file and cell a2 (formerly Genus_Name) to #OTU ID - that file was called table.from_biom.txt
#for more info visit http://biom-format.org/documentation/biom_conversion.html

# converting adapted table to .biom format

biom convert -i table.from_biom.txt -o table_adapt.biom --table-type="OTU table" --to-hdf5

# now that the data is in biom format, we can start working in qiime2
# any qiime2 later than 2020.6 has incompatibility issues with songbird and will throw an error

conda activate qiime2-2020.6

qiime tools import \
--input-path table_adapt.biom \
--type 'FeatureTable[Frequency]' \
--input-format BIOMV210Format \
--output-path feature-table.qza

///////////////////////////////////////////////////////////////////////////////

  Running Songbird for differential abundance

///////////////////////////////////////////////////////////////////////////////

# installing songbird

pip install songbird
qiime dev refresh-cache

# removing controls

qiime feature-table filter-samples \
--i-table feature-table.qza \
--m-metadata-file milk_anomaly_metadata.txt \
--p-where "[sample] = 'sample'" \
--o-filtered-table sample-table.qza

# run model with Category and DateColleted as variables

qiime songbird multinomial \
--i-table sample-table.qza \
--m-metadata-file milk_anomaly_metadata.txt \
--p-formula "Category+DateCollected" \
--p-epochs 10000 \
--p-differential-prior 0.5 \
--p-training-column Testing \
--p-summary-interval 1 \
--o-differentials differentials.qza \
--o-regression-stats regression-stats.qza \
--o-regression-biplot regression-biplot.qza \
--verbose

# looking at model fit

qiime songbird summarize-single \
	--i-regression-stats regression-stats.qza \
	--o-visualization regression-summary.qzv

# generating a null model

qiime songbird multinomial \
	--i-table sample-table.qza \
	--m-metadata-file milk_anomaly_metadata.txt \
	--p-formula "1" \
	--p-epochs 10000 \
	--p-differential-prior 0.5 \
	--p-training-column Testing \
	--p-summary-interval 1 \
	--o-differentials null-diff.qza \
	--o-regression-stats null-stats.qza \
	--o-regression-biplot null-biplot.qza

# comparing model to null

qiime songbird summarize-paired \
	--i-regression-stats regression-stats.qza \
	--i-baseline-stats null-stats.qza \
	--o-visualization paired-summary.qzv

# generating a baseline model with only Category

# this will ensure that the second column of differentials is "C(Category, Treatment('Baseline'))"[T.OutsideFarm] -- that is, the association with OutsideFarm-valued samples using Baseline-valued samples as a reference.

# because we have 3 categories (Baseline, OutsideFarm, and TxAntibiotic) we will get two columns of differentials, each comparing the values to the Baseline samples as reference.

# for more see https://github.com/biocore/songbird

qiime songbird multinomial \
--i-table sample-table.qza \
--m-metadata-file milk_anomaly_metadata.txt \
--p-formula "C(Category, Treatment('Baseline'))" \
--p-epochs 10000 \
--p-differential-prior 0.5 \
--p-training-column Testing \
--p-summary-interval 1 \
--o-differentials differentials-cat-baseline.qza \
--o-regression-stats regression-cat-baseline-stats.qza \
--o-regression-biplot regression-cat-baseline-biplot.qza \
--verbose

# comparing category only model to null

qiime songbird summarize-paired \
	--i-regression-stats regression-cat-stats.qza \
	--i-baseline-stats null-stats.qza \
	--o-visualization paired-cat-baseline-summary.qzv

# Pseudo Q-squared: 0.029888, although low, our model is learning something useful.

# Vizualizing with qurro

qiime qurro differential-plot \
  --i-ranks differentials-cat-baseline.qza \
  --i-table sample-table.qza \
  --m-sample-metadata-file milk_anomaly_metadata.txt \
  --verbose \
  --o-visualization qurro_plot_cat_baseline.qzv

# add changes
git add .

# check what was added
#git status

# commit changes
#git commit -m "  "
